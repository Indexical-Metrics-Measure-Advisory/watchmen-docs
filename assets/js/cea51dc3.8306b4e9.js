"use strict";(globalThis.webpackChunkwatchmen_docs=globalThis.webpackChunkwatchmen_docs||[]).push([[1924],{5257:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>h,frontMatter:()=>t,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"doll/data-service","title":"Data Service","description":"Data service is designed for serve such as definition CURD, pipeline and inquiry. It is split to several modules:","source":"@site/versioned_docs/version-16.4/040-doll/100-data-service.md","sourceDirName":"040-doll","slug":"/doll/data-service","permalink":"/docs/16.4/doll/data-service","draft":false,"unlisted":false,"editUrl":"https://github.com/Indexical-Metrics-Measure-Advisory/watchmen-docs/tree/main/versioned_docs/version-16.4/040-doll/100-data-service.md","tags":[],"version":"16.4","lastUpdatedBy":"luke0623","lastUpdatedAt":1770208783000,"sidebarPosition":100,"frontMatter":{"id":"data-service","title":"Data Service","sidebar_position":100},"sidebar":"sidebar","previous":{"title":"Doll Overview","permalink":"/docs/16.4/doll/doll-index"},"next":{"title":"Pipeline Service","permalink":"/docs/16.4/doll/pipeline-service"}}');var r=i(74848),a=i(28453);const t={id:"data-service",title:"Data Service",sidebar_position:100},d="Data Service",l={},c=[{value:"Model",id:"model",level:2},{value:"Tenant Based",id:"tenant-based",level:3},{value:"User Based",id:"user-based",level:3},{value:"Others",id:"others",level:3},{value:"Meta Service",id:"meta-service",level:2},{value:"Storage",id:"storage",level:2},{value:"Snowflake Sequence Generator",id:"snowflake-sequence-generator",level:3},{value:"Extend Data Source Types",id:"extend-data-source-types",level:3},{value:"Data Kernel and Surface",id:"data-kernel-and-surface",level:2},{value:"Cache service",id:"cache-service",level:3},{value:"Topic Data",id:"topic-data",level:3},{value:"Retrieve data of single topic",id:"retrieve-data-of-single-topic",level:4},{value:"Truncate a single topic",id:"truncate-a-single-topic",level:4},{value:"Patch topic data",id:"patch-topic-data",level:4}];function o(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"data-service",children:"Data Service"})}),"\n",(0,r.jsx)(n.p,{children:"Data service is designed for serve such as definition CURD, pipeline and inquiry. It is split to several modules:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Model,"}),"\n",(0,r.jsxs)(n.li,{children:["Storage,","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"MySQL"})," & ",(0,r.jsx)(n.code,{children:"MariaDB"}),","]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Oracle"}),","]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"MongoDB"}),","]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"MSSQL"}),","]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Meta,"}),"\n",(0,r.jsx)(n.li,{children:"Data Kernel,"}),"\n",(0,r.jsx)(n.li,{children:"Data Surface."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"model",children:"Model"}),"\n",(0,r.jsxs)(n.p,{children:["In ",(0,r.jsx)(n.code,{children:"watchmen-model"}),", all tuples are defined. Basically, they can be arranged to 3 catalogs:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Tenant based,"}),"\n",(0,r.jsx)(n.li,{children:"User based,"}),"\n",(0,r.jsx)(n.li,{children:"Others."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"tenant-based",children:"Tenant Based"}),"\n",(0,r.jsx)(n.p,{children:"Tenant based models are designed to be shared in tenant, most tenant based models have optimistic lock:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Tenant,"}),"\n",(0,r.jsx)(n.li,{children:"User,"}),"\n",(0,r.jsx)(n.li,{children:"Data Source,"}),"\n",(0,r.jsx)(n.li,{children:"External Writer,"}),"\n",(0,r.jsx)(n.li,{children:"User Group,"}),"\n",(0,r.jsx)(n.li,{children:"Space,"}),"\n",(0,r.jsx)(n.li,{children:"Enumeration,"}),"\n",(0,r.jsx)(n.li,{children:"Topic,"}),"\n",(0,r.jsx)(n.li,{children:"Pipeline,"}),"\n",(0,r.jsx)(n.li,{children:"Catalog,"}),"\n",(0,r.jsx)(n.li,{children:"Monitor Rule (no optimistic lock declared)."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"user-based",children:"User Based"}),"\n",(0,r.jsx)(n.p,{children:"User based models are designed to store data which belongs to particular user only:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Favorite,"}),"\n",(0,r.jsx)(n.li,{children:"Last Snapshot,"}),"\n",(0,r.jsx)(n.li,{children:"Personal Access Token,"}),"\n",(0,r.jsx)(n.li,{children:"Connected Space,"}),"\n",(0,r.jsx)(n.li,{children:"Connected Space Graphic,"}),"\n",(0,r.jsx)(n.li,{children:"Subject,"}),"\n",(0,r.jsx)(n.li,{children:"Report,"}),"\n",(0,r.jsx)(n.li,{children:"Dashboard,"}),"\n",(0,r.jsx)(n.li,{children:"Pipeline Graphic."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"others",children:"Others"}),"\n",(0,r.jsx)(n.p,{children:"Typically, model which is not a tenant based or an user based, is designed for system purpose."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Factor Index"}),"\n",(0,r.jsx)(n.li,{children:"Pipeline Index"}),"\n",(0,r.jsx)(n.li,{children:"Key Store"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"meta-service",children:"Meta Service"}),"\n",(0,r.jsxs)(n.p,{children:["The CRUD operations of models are provided by ",(0,r.jsx)(n.code,{children:"watchmen-meta"}),", and persistent layer of meta service is provided by ",(0,r.jsx)(n.code,{children:"watchmen-storage"}),". All\nmetadata are stored in one storage, it can be RDS or NoSQL."]}),"\n",(0,r.jsx)(n.h2,{id:"storage",children:"Storage"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"watchmen-storage"})," is spi for different types of storages, such as MySQL, Oracle, etc. To enable the particular storage, the adaptive\nimplementation module should be included."]}),"\n",(0,r.jsxs)(n.p,{children:["Storage provides persistent layer both for meta service and data service. For meta service, find configuration\ndetails ",(0,r.jsxs)(n.strong,{children:[(0,r.jsx)(n.a,{href:"../installation/config#meta",children:"here"}),"."]})]}),"\n",(0,r.jsx)(n.h3,{id:"snowflake-sequence-generator",children:"Snowflake Sequence Generator"}),"\n",(0,r.jsx)(n.p,{children:"In storage module, there is a built-in snowflake sequence generator. Small changes made based on the standard algorithm, which are:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"At most 4 data centers are supported, default is 0,"}),"\n",(0,r.jsx)(n.li,{children:"At most 1024 workers for each data center are supported, default is 0 too."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"It is expected that worker ids setting can be ignored when deploy watchmen to servers, it is no need to care about settings for each server\n, docker image and system variables of host server. Consider of this, a built-in mechanism called competitive worker is provided, and by\ndefault it is enabled. It acquires a worker id when server starting, and keep declaring itself alive to meta storage every 60 seconds when\ndefault settings is kept. Plus, an unused worker id would be released and reused after 1 day."}),"\n",(0,r.jsxs)(n.admonition,{type:"tip",children:[(0,r.jsx)(n.mdxAdmonitionTitle,{}),(0,r.jsxs)(n.p,{children:["Default competitive worker is based on persistent layer, all data can be found at ",(0,r.jsx)(n.code,{children:"snowflake_competitive_workers"}),". Manually clean dead\nworker ids when necessary."]})]}),"\n",(0,r.jsxs)(n.admonition,{type:"caution",children:[(0,r.jsx)(n.mdxAdmonitionTitle,{}),(0,r.jsx)(n.p,{children:"Declare data center id and worker id by system variables for each node separated is recommended where conditions permit. Simply disable the\ncompetitive workers by settings parameter."})]}),"\n",(0,r.jsx)(n.h3,{id:"extend-data-source-types",children:"Extend Data Source Types"}),"\n",(0,r.jsxs)(n.p,{children:["MySQL, Oracle, MSSQL and mongoDB are built-in now. If you want to extend a new data source type, follow the steps to\ncreate supporting a type ",(0,r.jsx)(n.code,{children:"SomeDB"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"First fork our repo, for server side,"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Add a new package, which named ",(0,r.jsx)(n.code,{children:"watchmen-storage-somedb"}),","]}),"\n",(0,r.jsxs)(n.li,{children:["Copy source from the analogue, such as from ",(0,r.jsx)(n.code,{children:"watchmen-storage-mysql"}),","]}),"\n",(0,r.jsxs)(n.li,{children:["Go through source codes, change them,","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["If it is only for topic data, only a few apis should be implemented, find ",(0,r.jsx)(n.code,{children:"watchmen-inquiry-trino"})," as a sample,"]}),"\n",(0,r.jsx)(n.li,{children:"If it is for metadata, most apis must be implemented except the apis which are used for inquiry subject and report data,"}),"\n",(0,r.jsx)(n.li,{children:"If it is for both metadata and topic data, all apis have to be implemented,"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Add data source types into ",(0,r.jsx)(n.code,{children:"DataSourceType"}),", which in ",(0,r.jsx)(n.code,{children:"watchmen-model"}),","]}),"\n",(0,r.jsx)(n.li,{children:"Add dependency into doll and dqc instance."}),"\n",(0,r.jsx)(n.li,{children:"Bingo!"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"For defined new data source type in web client, you need to,"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Add data source types into ",(0,r.jsx)(n.code,{children:"DataSourceType"}),", which in ",(0,r.jsx)(n.code,{children:"data-source-types.ts"}),","]}),"\n",(0,r.jsxs)(n.li,{children:["Add dropdown label into ",(0,r.jsx)(n.code,{children:"DataSourceTypeInput"}),", which in ",(0,r.jsx)(n.code,{children:"data-source-type-input.tsx"}),","]}),"\n",(0,r.jsx)(n.li,{children:"Bingo!"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"data-kernel-and-surface",children:"Data Kernel and Surface"}),"\n",(0,r.jsx)(n.p,{children:"A set of services and rest apis are provided by data kernel and surface. Pipeline and inquiry services are built based on data kernel."}),"\n",(0,r.jsx)(n.h3,{id:"cache-service",children:"Cache service"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Data Sources for topic data,"}),"\n",(0,r.jsx)(n.li,{children:"External writers,"}),"\n",(0,r.jsx)(n.li,{children:"Topics,"}),"\n",(0,r.jsx)(n.li,{children:"Pipelines,"}),"\n",(0,r.jsx)(n.li,{children:"Relationship between topics and pipelines,"}),"\n",(0,r.jsx)(n.li,{children:"Key store,"}),"\n",(0,r.jsx)(n.li,{children:"Tenant."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["A high frequency question is, how to refresh cache, there are multiple servers and only one node can be cleared when call clear cache rest\napi. For this situation, a heart beat cache refresher is built-in, and visit ",(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.a,{href:"../installation/config#data-kernel",children:"here"})})," for more\ndetails."]}),"\n",(0,r.jsxs)(n.admonition,{type:"caution",children:[(0,r.jsx)(n.mdxAdmonitionTitle,{}),(0,r.jsx)(n.p,{children:"Heart beat of in-memory cache is not recommend in production."})]}),"\n",(0,r.jsx)(n.h3,{id:"topic-data",children:"Topic Data"}),"\n",(0,r.jsx)(n.p,{children:"All topic data rest apis are available for tenant admin and super admin only."}),"\n",(0,r.jsx)(n.h4,{id:"retrieve-data-of-single-topic",children:"Retrieve data of single topic"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"curl \\\n--location \\ \n--request POST 'http://host:port/topic/data?topic_name=a_topic&tenant_id=1' \\\n--header 'Authorization: Bearer ...' \\\n--header 'Content-Type: application/json' \\\n--data-raw '{\n    \"pageNumber\": 1,\n    \"pageSize\": 9\n}'\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"topic_name"}),": case sensitive,"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tenant_id"}),": required when current user is super admin."]}),"\n"]}),"\n",(0,r.jsxs)(n.admonition,{type:"caution",children:[(0,r.jsx)(n.mdxAdmonitionTitle,{}),(0,r.jsx)(n.p,{children:"There is no page size limitation for this api, be careful about memory and data size."})]}),"\n",(0,r.jsx)(n.h4,{id:"truncate-a-single-topic",children:"Truncate a single topic"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"curl \\\n--location \\ \n--request DELETE 'http://host:port/topic/data/truncate?topic_name=a_topic&tenant_id=1' \\\n--header 'Authorization: Bearer ...'\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"topic_name"}),": case sensitive,"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tenant_id"}),": required when current user is super admin."]}),"\n"]}),"\n",(0,r.jsxs)(n.admonition,{type:"warning",children:[(0,r.jsx)(n.mdxAdmonitionTitle,{}),(0,r.jsx)(n.p,{children:"There is no rollback of truncate operation, it is equivalent with database truncate."})]}),"\n",(0,r.jsx)(n.h4,{id:"patch-topic-data",children:"Patch topic data"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"curl \\\n--location \\ \n--request PATCH 'http://host:port/topic/data/patch?topic_name=a_topic&patch_type=merge&tenant_id=1' \\\n--header 'Authorization: Bearer ...' \\\n--header 'Content-Type: application/json' \\\n--data-raw '{\n    ...\n}'\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"topic_name"}),": case sensitive,"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"patch_type"}),": one of ",(0,r.jsx)(n.code,{children:"merge"}),", ",(0,r.jsx)(n.code,{children:"insert"})," and ",(0,r.jsx)(n.code,{children:"delete"}),",","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["for ",(0,r.jsx)(n.code,{children:"merge"})," and ",(0,r.jsx)(n.code,{children:"delete"}),": a property ",(0,r.jsx)(n.code,{children:"id_"})," is required in body data,"]}),"\n",(0,r.jsxs)(n.li,{children:["for ",(0,r.jsx)(n.code,{children:"merge"})," and aggregation topic: a property ",(0,r.jsx)(n.code,{children:"version_"})," is required in body data,"]}),"\n",(0,r.jsxs)(n.li,{children:["for ",(0,r.jsx)(n.code,{children:"insert"}),": ",(0,r.jsx)(n.code,{children:"id_"})," will be generated, ",(0,r.jsx)(n.code,{children:"version_"})," is 1 when it is required,"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tenant_id"}),": required when current user is super admin."]}),"\n"]}),"\n",(0,r.jsxs)(n.admonition,{type:"warning",children:[(0,r.jsx)(n.mdxAdmonitionTitle,{}),(0,r.jsx)(n.p,{children:"No pipeline will be triggered on data patch."})]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>d});var s=i(96540);const r={},a=s.createContext(r);function t(e){const n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);